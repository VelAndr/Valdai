# Технология интеграции горелки пеллетного котла Вадлай с системой умного дома Domoticz

В результате проведенных работ мы получим следующие результаты:
- Отображение текущего режима работы, температур подачи и обратки котла
- Ведение контроля за потреблением пеллет котла. После наполнения бункера необходимо обнулить счетчик нажатием на кнопку, и расход пеллет будет отображаться в системе.
- Опционально интегрированный с системой термостат
Таким образом, в дальнейшем Вы сможете настроить необходимые уведомления или реакцию системы на поведение котла.

### 0. Установка Domoticz
Установка Domoticz описана в https://www.domoticz.com/wiki/Main_Page
Система Domoticz имеет хорошую русификацию, и в дальнейшем все настройки будут описаны именно для русифицированного интерфейса.

### 1. Разбор основных параметров котла.
Для этого в разделе **НАСТРОЙКА/ОБОРУДОВАНИЕ** создаем новое оборудование со следующими параметрами:

- **Имя:** - любое, к примеру "Valdai"
- **Тип:** HTTP/HTTPS poller
- **Способ:** GET
- **URL:** http://IP_котла/status.xml
- **Команда:** это место пока оставляем пустым, потом пропишем туда имя скрипта-парсера
- **Обновить:** через сколько секунд опрашивать котел. Чаще 5 секунд не рекомендую, поскольку может уменьшиться точность вычисления расхода пеллет. У меня установлено 10 секунд.

Все остальные параметры не трогаем, давим кнопку "Добавить"

В пункте с свежесозданным оборудованием создаем необходимые виртуальные устройства с помощью кнопки "Создать виртуальные датчики":

|Название датчика|тип датчика|
|---|---|
|Подача котла|Температура|
|Обратка котла|Температура|
|Мощность котла|Потребление (электроэнергии)|
|Режим котла|Текст|
|Пламя|Custom sensor, метка оси - pt.|
|Расход пеллет тек.|Custom sensor, метка оси - гр.|

Также создаем еще пару виртуальных устройств для учета потребления пеллет

|Название датчика|тип датчика|
|---|---|
|Израсходовано пеллет|Scale (Weight)|
|Сброс счетчика расхода|Переключатель|

Номера (IDX) этих устройств можно посмотреть в разделе **НАСТРОЙКА/УСТРОЙСТВА**. Меняем в в файле парсера *valdai.lua* индексы устройств согласно таблице:

|IDX в скрипте|меняем на|
|---|---|
|41|температура подачи|
|42|температура обратки|
|43|мощность|
|44|режим котла|
|45|уровень пламени|
|46|текущий расход пеллет|

После этого копируем файл **valdai.lua** в каталог домотикза *./scripts/lua_parsers* ( У меня он установлен в /home/pi/domoticz, поэтому полный путь выглядит как */home/pi/domoticz/scripts/lua_parsers*)

Затем еще раз открываем раздел **НАСТРОЙКА/ОБОРУДОВАНИЕ** и давим на строчке с нашим опросником котла.
Вписываем в поле "Команда" имя скрипта - *valdai.lua* и жмем кнопку "ОБНОВИТЬ", которая находится выше параметров оборудования. Не надо нажимать на кнопку "ДОБАВИТЬ" внизу, это создаст клона оборудования, и его придется удалять. 

Все! Если Вы все успешно сделали, то ваши датчики заполнятся значениями, получаемыми от котла.

### 2. Добавляем контроль потребления пеллет.
В предыдущем пункте мы создали два устройства - для отображения веса пеллет и для сброса счетчика.
Для подсчета пеллет необходимо в домотикз добавить скрипт *consum.lua*, поместив его в папку ./scripts/dzVents/scripts (у меня это каталог */home/pi/domoticz/scripts/dzVents/scripts*).
Данный скрипт можно добавить также через раздел **НАСТРОЙКА/ДОПОЛНИТЕЛЬНО/СОБЫТИЯ**, создав скрипт, скопировав туда содержимое файла, сохранить и включить его.
Перед копированием необходимо сменить IDX устройств в скрипте на Ваши: **38** - устройство сброса счетчика пеллет, **39** - вес израсходованных пеллет, **46** - текущий расход пеллет
Все! Если Вы все успешно сделали, то вес израсходованных пеллет будет увеличиваться по мере работы котла, и нажатие кнопки сброса счетчика приведет к обнулению веса.
Необходимо отметить, что для корректного расчета веса необходимо его корректное задание в настройках котла. Если же заданный в настройках вес отличается от реального, Вы можете модифицировать данный скрипт, введя коэффициент коррекции веса.

### 3. Задание параметров котла из системы.
... продолжение следует

### 4. Комнатный термостат
Для комнатного термостата требуется внешний модуль реле и датчик комнатной температуры (например, напрямую подключенный к Raspberry Pi, через ESP8266/Sonoff, датчик MySensors, систему Xiaomi или другим способом). У меня это реле подключено параллельно дешевому комнатному термостату, настроенному на 8 градусов (для поддержания положительной температуры в доме).
Когда термостат включен, то он поддерживает заданную температуту в помещении, при его выключении температура поддерживается комнатным термостатом.

Требуется создать следующие виртуальные устройства:
- уст. температуры - Установки термостата
- Вкл. термостат - переключатель

Меняем в скрипте termostat.lua следующие IDX устройств:

|IDX в скрипте|меняем на|
|---|---|
|7|на датчик температуры для термостата|
|24|на устройство, управляющее реле|
|31|на устройство с установкой температуры термостата|
|32|на переключатель, включающий управление по комнатному термостату|

При необходимости, можно скорректировать переменную Hist, определяющую гистерезис термостата.

После этого скрипт termostat.lua добавляется в систему согласно п.2 данной инструкции.

Все! Если Вы все успешно сделали, то у Вас появился продвинутый комнатный термостат. С его помощью можно удаленно прогреть загородный дом, и приехать уже в теплый дом. С помощью программы **telebot**, размещщеной в моем репозитории, можно осуществить контроль за котлом и управление термостатом с помощью бота Telegram.
